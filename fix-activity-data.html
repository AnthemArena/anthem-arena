<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fix Activity Data</title>
    <style>
        body {
            font-family: monospace;
            background: #0a0a0a;
            color: #C8AA6E;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { color: #C8AA6E; }
        .info {
            background: rgba(200, 170, 110, 0.1);
            border: 1px solid #C8AA6E;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        button {
            background: #C8AA6E;
            color: #0a0a0a;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        }
        button:hover {
            background: #D4B87A;
        }
        .progress {
            margin-top: 1rem;
            padding: 1rem;
            background: #1a1a1a;
            border-radius: 8px;
            display: none;
        }
        .progress.active {
            display: block;
        }
    </style>
</head>
<body>
    <h1>üîß Fix Activity Data</h1>
    
    <div class="info">
        <p>‚úÖ Fixes song names and video IDs</p>
        <p>‚úÖ Adds missing choice field (song1/song2)</p>
        <p>‚úÖ Updates Anonymous ‚Üí your username</p>
        <p>‚úÖ Updates avatars</p>
    </div>
    
    <button id="fix-btn">üöÄ Run Fix Now</button>
    
    <div id="progress" class="progress">
        <p>Running... check console (F12) for details</p>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        async function fixActivityData() {
            console.log('üîß Starting activity data fix...');
            
            try {
                // Load music data from JSON
                console.log('üéµ Loading music data...');
                const musicResponse = await fetch('/data/music-videos.json');
                const musicData = await musicResponse.json();
                
                console.log(`‚úÖ Loaded ${musicData.length} songs`);
                
                // Load matches from tournaments/2025-worlds-anthems/matches
                console.log('üèÜ Loading matches from tournament...');
                const matchMap = {};
                const TOURNAMENT_ID = '2025-worlds-anthems';
                
                const matchesRef = collection(db, 'tournaments', TOURNAMENT_ID, 'matches');
                const matchesSnapshot = await getDocs(matchesRef);
                
                matchesSnapshot.forEach(matchDoc => {
                    const match = matchDoc.data();
                    matchMap[matchDoc.id] = match;
                    if (match.matchId) matchMap[match.matchId] = match;
                });
                
                console.log(`‚úÖ Loaded ${matchesSnapshot.size} matches`);
                
                // ‚úÖ NEW: Load votes to get choice field
                console.log('üó≥Ô∏è Loading votes...');
                const votesRef = collection(db, 'votes');
                const votesSnapshot = await getDocs(votesRef);
                
                const votesMap = new Map();
                votesSnapshot.forEach(voteDoc => {
                    const voteData = voteDoc.data();
                    const key = `${voteData.matchId}_${voteData.userId}`;
                    votesMap.set(key, voteData.choice); // "song1" or "song2"
                });
                
                console.log(`‚úÖ Loaded ${votesMap.size} votes for choice mapping`);
                
                // Load user profiles
                console.log('üë§ Loading user profiles...');
                const profilesRef = collection(db, 'profiles');
                const profilesSnapshot = await getDocs(profilesRef);
                
                const userProfiles = {};
                profilesSnapshot.forEach(profileDoc => {
                    const profile = profileDoc.data();
                    userProfiles[profileDoc.id] = profile;
                });
                
                console.log(`‚úÖ Loaded ${profilesSnapshot.size} user profiles`);
                
                // Get all activity documents
                console.log('üìÑ Loading activity documents...');
                const activityRef = collection(db, 'activity');
                const activitySnapshot = await getDocs(activityRef);
                
                console.log(`‚úÖ Found ${activitySnapshot.size} activity documents`);
                
                let fixedSongs = 0;
                let fixedUsernames = 0;
                let fixedChoices = 0;
                let skipped = 0;
                let errors = 0;
                
                // Process each activity document
                for (const activityDoc of activitySnapshot.docs) {
                    const activity = activityDoc.data();
                    const activityId = activityDoc.id;
                    
                    try {
                        const updates = {};
                        let needsUpdate = false;
                        
                       // ========================================
// FIX 1: Song data
// ========================================
const needsSongFix = 
    !activity.songId || 
    activity.songId === 'song1' || 
    activity.songId === 'song2' ||
    !activity.matchTitle ||
    activity.matchTitle.includes('Match round-') ||
    activity.matchTitle.includes('Song 1') ||
    activity.matchTitle.includes('Song 2');

// Get match data for this activity
const match = matchMap[activity.matchId];

if (match && match.song1 && match.song2) {
    const song1 = match.song1;
    const song2 = match.song2;
    
    // ‚úÖ Get choice from votes
    const voteKey = `${activity.matchId}_${activity.userId}`;
    const choice = votesMap.get(voteKey) || activity.choice;
    
    // Determine which song was voted for
    const votedForSong1 = choice === 'song1';
    const votedSong = votedForSong1 ? song1 : song2;
    
    // ‚úÖ ALWAYS check if songId matches the voted song
    const correctVideoId = votedSong.videoId;
    const needsSongIdFix = activity.songId !== correctVideoId;
    
    if (needsSongFix || needsSongIdFix) {
        updates.songId = correctVideoId;
        updates.songTitle = votedSong.shortTitle || votedSong.title;
        updates.matchTitle = `${song1.shortTitle || song1.title} vs ${song2.shortTitle || song2.title}`;
        
        needsUpdate = true;
        fixedSongs++;
        console.log(`üéµ Fixed: ${updates.matchTitle} (voted: ${votedSong.shortTitle || votedSong.title}, videoId: ${correctVideoId})`);
    }
} else if (needsSongFix) {
    console.warn(`‚ö†Ô∏è Match not found or missing song data: ${activity.matchId}`);
    errors++;
}

// ========================================
// ‚úÖ FIX 2: Add choice field if missing
// ========================================
                        if (!activity.choice) {
                            const voteKey = `${activity.matchId}_${activity.userId}`;
                            const choice = votesMap.get(voteKey);
                            
                            if (choice) {
                                updates.choice = choice;
                                needsUpdate = true;
                                fixedChoices++;
                                console.log(`üó≥Ô∏è Added choice: ${choice} for ${activity.songTitle}`);
                            } else {
                                console.warn(`‚ö†Ô∏è No vote found for activity ${activityId}`);
                            }
                        }
                        
                        // ========================================
                        // FIX 3: Username backfill
                      // ========================================
// FIX 3: Username & Avatar backfill
// ========================================
const currentUsername = activity.username || 'Anonymous';
const userId = activity.userId;

if (userId) {
    // Check if user has a profile
    if (userProfiles[userId]) {
        // ‚úÖ User has profile - update activity to match
        const profile = userProfiles[userId];
        const profileUsername = profile.username || 'Anonymous';
        const profileAvatar = profile.avatar;
        
        if (profileUsername !== 'Anonymous' && currentUsername !== profileUsername) {
            updates.username = profileUsername;
            needsUpdate = true;
            fixedUsernames++;
            console.log(`üë§ Updated: "${currentUsername}" ‚Üí "${profileUsername}"`);
        }
        
        if (profileAvatar && JSON.stringify(activity.avatar) !== JSON.stringify(profileAvatar)) {
            updates.avatar = profileAvatar;
            needsUpdate = true;
        }
    } else {
        // ‚ö†Ô∏è User has NO profile - they voted before auto-generation
        console.warn(`‚ö†Ô∏è User ${userId} has no profile - voted before auto-generation system`);
        // The activity will keep "Anonymous" until they visit again
        // vote.js will create their profile on next visit
    }
}
                        
                        // ========================================
                        // Apply updates
                        // ========================================
                        if (needsUpdate) {
                            await updateDoc(doc(db, 'activity', activityId), updates);
                            console.log(`‚úÖ Updated ${activityId}`);
                        } else {
                            skipped++;
                        }
                        
                    } catch (error) {
                        console.error(`‚ùå Error fixing ${activityId}:`, error);
                        errors++;
                    }
                }
                
                console.log(`\nüéâ COMPLETE!`);
                console.log(`üéµ Fixed song data: ${fixedSongs}`);
                console.log(`üó≥Ô∏è Fixed choice field: ${fixedChoices}`);
                console.log(`üë§ Fixed usernames: ${fixedUsernames}`);
                console.log(`‚è≠Ô∏è Skipped: ${skipped}`);
                console.log(`‚ùå Errors: ${errors}`);
                
                alert(`Fix complete!\n\nüéµ Songs: ${fixedSongs}\nüó≥Ô∏è Choices: ${fixedChoices}\nüë§ Usernames: ${fixedUsernames}\n‚è≠Ô∏è Skipped: ${skipped}\n‚ùå Errors: ${errors}`);
                
            } catch (error) {
                console.error('‚ùå Fatal error:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Attach event listener after DOM loads
        document.getElementById('fix-btn').addEventListener('click', fixActivityData);
    </script>
</body>
</html>